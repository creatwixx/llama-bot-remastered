services:
  # Note: When deploying to Railway, use Railway's managed PostgreSQL instead of this
  # For local development with Railway DB, skip starting db/redis containers
  # Use docker-compose.local.yml if you want local Docker DB/Redis
  
  api:
    build:
      context: ..
      dockerfile: infra/Dockerfile.api
    container_name: llamabot-api
    working_dir: /app/packages/llama-api
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - API_PORT=${API_PORT:-3000}
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${API_PORT:-3000}:3000"
    # depends_on: db  # Commented out - using Railway DB or external DB
    volumes:
      - ../packages/llama-api:/app/packages/llama-api
      - api-node-modules:/app/packages/llama-api/node_modules
    networks:
      - llamabot-network
    restart: unless-stopped

  bot:
    build:
      context: ..
      dockerfile: infra/Dockerfile.bot
    container_name: llamabot-bot
    working_dir: /app/packages/llama-bot
    env_file:
      - .env
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - DISCORD_APP_ID=${DISCORD_APP_ID}
      - DISCORD_GUILD_ID=${DISCORD_GUILD_ID}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${BOT_PORT:-8080}:8080"
    # depends_on: db, redis  # Commented out - using Railway/external services
    volumes:
      - ../packages/llama-bot:/app/packages/llama-bot
      - bot-node-modules:/app/packages/llama-bot/node_modules
    networks:
      - llamabot-network
    restart: unless-stopped

  client:
    build:
      context: ..
      dockerfile: infra/Dockerfile.client
    container_name: llamabot-client
    ports:
      - "4173:4173"
    depends_on:
      - api
    volumes:
      - ../packages/llama-client:/app/packages/llama-client
      - client-node-modules:/app/packages/llama-client/node_modules
    networks:
      - llamabot-network
    restart: unless-stopped

volumes:
  api-node-modules:
  bot-node-modules:
  client-node-modules:

networks:
  llamabot-network:
    driver: bridge

